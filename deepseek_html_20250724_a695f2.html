<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Araç Vergi Optimizasyon Simülatörü</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            overflow: hidden;
            position: relative;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><polygon points="0,100 100,0 100,100" opacity="0.05"/></svg>');
            background-size: cover;
        }
        
        h1, h2, h3, h4 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid var(--accent-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 15px;
        }
        
        input, select {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            background: white;
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(44, 62, 80, 0.3);
        }
        
        .btn-optimize {
            background: linear-gradient(135deg, var(--success-color) 0%, #219955 100%);
        }
        
        .btn-optimize:hover {
            box-shadow: 0 7px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .btn-option {
            padding: 14px;
            background-color: white;
            color: var(--dark-color);
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .btn-option:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.08);
        }
        
        .btn-option.active {
            background: linear-gradient(135deg, var(--accent-color) 0%, #2980b9 100%);
            color: white;
            border-color: var(--accent-color);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }
        
        .results-section {
            margin-top: 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid #e0e0e0;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .result-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        
        .result-card:hover {
            transform: translateY(-5px);
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid #eee;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 15px;
        }
        
        .result-value {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .highlight {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(41, 128, 185, 0.1) 100%);
            padding: 18px;
            border-radius: 10px;
            margin: 18px 0;
            border-left: 4px solid var(--accent-color);
        }
        
        .chart-container {
            position: relative;
            height: 380px;
            margin-top: 30px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: linear-gradient(135deg, var(--light-color) 0%, #dfe6e9 100%);
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        tr:hover {
            background-color: rgba(0,0,0,0.02);
        }
        
        .ai-recommendation {
            background: linear-gradient(135deg, #e8f5e9 0%, #d0ece7 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            border-left: 4px solid var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.2); }
            70% { box-shadow: 0 0 0 12px rgba(39, 174, 96, 0); }
            100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
        }
        
        .ai-recommendation h4 {
            margin-top: 0;
            color: var(--success-color);
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            border-bottom: 1px dotted var(--secondary-color);
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: var(--secondary-color);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .badge-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #219955 100%);
            color: white;
        }
        
        .badge-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #e67e22 100%);
            color: white;
        }
        
        .badge-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c0392b 100%);
            color: white;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
        }
        
        .summary-title {
            text-align: center;
            font-size: 22px;
            margin-bottom: 20px;
            color: white;
        }
        
        .summary-value {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin: 15px 0;
            color: var(--accent-color);
        }
        
        .summary-label {
            text-align: center;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .footer-note {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        @media (max-width: 768px) {
            .btn-group {
                grid-template-columns: 1fr 1fr;
            }
            
            .result-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .actions .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Araç Vergi Optimizasyon Simülatörü</h1>
            <p>Sıfır araç alım-satımında maksimum vergisel avantaj hesaplama aracı</p>
        </header>
        
        <div class="card">
            <h2>1. Araç Bilgileri</h2>
            
            <div class="form-group">
                <label for="vehicleType">Araç Türü</label>
                <select id="vehicleType" disabled>
                    <option value="new">Sıfır Araç</option>
                </select>
                <small>Vergi avantajları sadece sıfır araçlar için geçerlidir</small>
            </div>
            
            <div class="form-group">
                <label for="engineVolume">Motor Hacmi</label>
                <div class="btn-group" data-type="motor-volume">
                    <button type="button" class="btn-option active" data-value="1600">≤1600cc</button>
                    <button type="button" class="btn-option" data-value="2000">1601-2000cc</button>
                    <button type="button" class="btn-option" data-value="above">>2000cc</button>
                </div>
                <small>Motor hacmi ÖTV oranını ve gider sınırını belirler</small>
            </div>
            
            <div class="form-group">
                <label for="salePeriod">Satış Süresi</label>
                <div class="btn-group" data-type="sale-period">
                    <button type="button" class="btn-option" data-value="6">6 Ay</button>
                    <button type="button" class="btn-option" data-value="12">12 Ay</button>
                    <button type="button" class="btn-option" data-value="18">18 Ay</button>
                    <button type="button" class="btn-option active" data-value="24">24 Ay</button>
                </div>
                <small>Daha uzun süreler daha yüksek amortisman avantajı sağlar</small>
            </div>
        </div>
        
        <div class="card">
            <h2>2. Fiyat Bilgileri</h2>
            
            <div class="form-group">
                <label for="purchasePrice">Alış Fiyatı (KDV + ÖTV Hariç)</label>
                <input type="text" id="purchasePrice" placeholder="1.000.000" data-type="currency" value="850000">
                <small>Aracın KDV ve ÖTV hariç fiyatını giriniz</small>
            </div>
            
            <div class="form-group">
                <label for="salePrice">Tahmini Satış Fiyatı</label>
                <input type="text" id="salePrice" placeholder="1.200.000" data-type="currency" value="1100000">
                <small>Aracın satışında talep edeceğiniz fiyat</small>
            </div>
        </div>
        
        <div class="card">
            <h2>3. Gider Kalemleri <span class="badge badge-success">%70'i gider yazılabilir</span></h2>
            <p>KDV ve ÖTV hariç giderlerin sadece %70'i gider yazılabilir (MTV hariç)</p>
            
            <table id="expensesTable">
                <thead>
                    <tr>
                        <th>Gider Türü</th>
                        <th>Tutar (TL)</th>
                        <th>Gider Yazılabilir</th>
                        <th>İşlem</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <select class="expense-type">
                                <option value="mtv">MTV</option>
                                <option value="fuel" selected>Yakıt</option>
                                <option value="insurance">Sigorta</option>
                                <option value="maintenance">Bakım</option>
                                <option value="tires">Lastik</option>
                                <option value="parking">Otopark</option>
                                <option value="cleaning">Temizlik</option>
                                <option value="leasing">Leasing</option>
                                <option value="other">Diğer</option>
                            </select>
                        </td>
                        <td><input type="text" class="expense-amount" placeholder="10.000" data-type="currency" value="15000"></td>
                        <td class="deductible-rate">%70</td>
                        <td><button type="button" class="btn btn-secondary remove-expense">Sil</button></td>
                    </tr>
                </tbody>
            </table>
            
            <button type="button" id="addExpense" class="btn">+ Gider Ekle</button>
        </div>
        
        <div class="card ai-recommendation" id="aiRecommendation">
            <h4><i class="fas fa-robot"></i> Optimizasyon Önerileri</h4>
            <div id="aiRecommendationText">
                <p>24 aylık satış süresini seçerek amortisman avantajınızı %80'e çıkarabilirsiniz.</p>
                <p>Giderlerinizi artırarak vergi avantajınızı maksimize edebilirsiniz.</p>
                <p>2000cc altı araçlarda gider sınırı daha yüksek olduğundan daha avantajlı olabilir.</p>
            </div>
        </div>
        
        <button type="button" id="calculateBtn" class="btn btn-optimize">Vergi Avantajını Hesapla</button>
        
        <div class="results-section" id="results">
            <h2>Vergi Avantajı Analizi</h2>
            
            <div class="result-grid">
                <div class="result-card">
                    <h3>Maliyet Analizi</h3>
                    
                    <div class="result-item">
                        <span class="result-label">Alış Fiyatı:</span>
                        <span class="result-value" id="resultPurchasePrice">850.000,00 ₺</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">ÖTV (<span id="otvRate">45</span>%):</span>
                        <span class="result-value" id="resultOtv">382.500,00 ₺</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">KDV (%18):</span>
                        <span class="result-value" id="resultKdv">222.030,00 ₺</span>
                    </div>
                    
                    <div class="highlight">
                        <div class="result-item">
                            <span class="result-label">Toplam Maliyet:</span>
                            <span class="result-value" id="resultTotalCost">1.454.530,00 ₺</span>
                        </div>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>Satış Analizi</h3>
                    
                    <div class="result-item">
                        <span class="result-label">Satış Fiyatı:</span>
                        <span class="result-value" id="resultSalePrice">1.100.000,00 ₺</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">KDV (%18):</span>
                        <span class="result-value" id="resultSaleKdv">198.000,00 ₺</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">KDV Farkı:</span>
                        <span class="result-value" id="resultKdvDifference">-24.030,00 ₺</span>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>Vergisel Avantajlar</h3>
                    
                    <div class="result-item">
                        <span class="result-label">Amortisman (<span id="depreciationRate">80</span>%):</span>
                        <span class="result-value" id="resultDepreciation">680.000,00 ₺</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">Giderler (KDV Hariç):</span>
                        <span class="result-value" id="resultExpenses">10.500,00 ₺</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label tooltip">Gider Kısıt Sınırı:
                            <span class="tooltiptext">Motor hacmine göre değişen gider kısıt sınırı</span>
                        </span>
                        <span class="result-value" id="resultExpenseLimit">1.100.000,00 ₺</span>
                    </div>
                    
                    <div class="highlight">
                        <div class="result-item">
                            <span class="result-label">Net Vergi Avantajı (KV %25):</span>
                            <span class="result-value" id="resultTaxAdvantage">166.617,50 ₺</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-title">Toplam Vergi Avantajı</div>
                <div class="summary-value" id="summaryTaxAdvantage">166.617,50 ₺</div>
                <div class="summary-label">Bu tutar şirketinizin ödeyeceği kurumlar vergisinden düşülebilir</div>
            </div>
            
            <div class="chart-container">
                <canvas id="taxChart"></canvas>
            </div>
            
            <div class="actions">
                <button type="button" id="pdfExport" class="btn">PDF Olarak Kaydet</button>
                <button type="button" id="optimizeBtn" class="btn btn-optimize">Otomatik Optimize Et</button>
            </div>
        </div>
        
        <div class="footer-note">
            <p>Bu simülatör Türk vergi mevzuatına göre hazırlanmıştır. Vergi avantajlarından yararlanmak için muhasebe uzmanınıza danışınız.</p>
            <p>© 2023 Vergi Optimizasyon Simülatörü | Versiyon 2.1</p>
        </div>
    </div>

    <script>
        // Global variables
        let taxChart = null;
        const { jsPDF } = window.jspdf;
        
        // Gider türlerine göre gider yazılabilirlik oranları
        const expenseDeductibility = {
            'mtv': 0.0,     // MTV tamamen gider yazılamaz
            'fuel': 0.7,     // Yakıt giderlerinin %70'i
            'insurance': 1.0, // Sigorta tamamen gider yazılabilir
            'maintenance': 1.0, // Bakım tamamen gider yazılabilir
            'tires': 0.7,    // Lastik giderlerinin %70'i
            'parking': 0.7,  // Otopark giderlerinin %70'i
            'cleaning': 0.7, // Temizlik giderlerinin %70'i
            'leasing': 1.0,  // Leasing giderleri tamamen
            'other': 0.7     // Diğer giderlerin %70'i
        };
        
        // Motor hacmine göre ÖTV oranları
        function getOtvRate(motorVolume) {
            switch(motorVolume) {
                case '1600': return 0.45; // %45
                case '2000': return 0.80; // %80
                case 'above': return 1.50; // %150
                default: return 0.45;
            }
        }
        
        // Motor hacmine göre gider sınırı
        function getExpenseLimit(motorVolume) {
            switch(motorVolume) {
                case '1600': return 1100000; // 1.100.000 TL
                case '2000': return 2100000; // 2.100.000 TL
                case 'above': return 990000;  // 990.000 TL
                default: return 1100000;
            }
        }
        
        // Satış süresine göre amortisman oranı (hızlandırılmış)
        function getDepreciationRate(salePeriod) {
            salePeriod = parseInt(salePeriod);
            if (salePeriod <= 6) return 0.50;  // 6 ay için %50
            if (salePeriod <= 12) return 0.60;  // 1 yıl için %60
            if (salePeriod <= 18) return 0.70;  // 18 ay için %70
            return 0.80; // 2 yıl için %80
        }
        
        // Para formatlama fonksiyonu (Türkçe)
        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', { 
                style: 'currency', 
                currency: 'TRY',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }
        
        // Sayıyı parse etme (Türkçe format desteği)
        function parseNumber(value) {
            // Değer yoksa 0 döndür
            if (!value) return 0;
            
            // String'e çevir
            let strValue = String(value);
            
            // Binlik ayırıcıları (nokta) ve ondalık ayırıcıyı (virgül) işle
            let cleanValue = strValue
                .replace(/\./g, '')  // Binlik ayırıcıları kaldır
                .replace(/,/g, '.'); // Ondalık ayırıcıyı noktaya çevir
                
            // Float'a çevir ve döndür
            let num = parseFloat(cleanValue);
            return isNaN(num) ? 0 : num;
        }
        
        // Input formatlama fonksiyonu
        function formatCurrencyInput(input) {
            // Focus olayı: formatı kaldır
            input.addEventListener('focus', function() {
                let num = parseNumber(this.value);
                this.value = num.toFixed(2).replace('.', ',');
            });
            
            // Blur olayı: formatla
            input.addEventListener('blur', function() {
                let num = parseNumber(this.value);
                this.value = formatCurrency(num);
            });
            
            // Input olayı: gerçek zamanlı formatlama
            input.addEventListener('input', function(e) {
                // Sadece sayı ve virgül kabul et
                this.value = this.value.replace(/[^0-9,]/g, '');
                
                // Birden fazla virgülü engelle
                let commaCount = (this.value.match(/,/g) || []).length;
                if (commaCount > 1) {
                    this.value = this.value.substring(0, this.value.lastIndexOf(','));
                }
            });
            
            // Başlangıçta formatla
            if (input.value) {
                let num = parseNumber(input.value);
                input.value = formatCurrency(num);
            }
        }
        
        // Sayfa yüklendiğinde çalışacak fonksiyon
        document.addEventListener('DOMContentLoaded', function() {
            // Buton gruplarını ayarla
            setupButtonGroups();
            
            // Gider tablosunu ayarla
            setupExpenseTable();
            
            // Tüm currency inputları formatla
            document.querySelectorAll('input[data-type="currency"]').forEach(input => {
                formatCurrencyInput(input);
            });
            
            // Hesaplama butonu
            document.getElementById('calculateBtn').addEventListener('click', calculateTaxAdvantage);
            
            // PDF export butonu
            document.getElementById('pdfExport').addEventListener('click', exportToPDF);
            
            // Optimize butonu
            document.getElementById('optimizeBtn').addEventListener('click', optimizeScenario);
            
            // Varsayılan değerlerle hesaplama yap
            calculateTaxAdvantage();
        });
        
        // Buton gruplarını ayarlama
        function setupButtonGroups() {
            // Motor hacmi butonları
            document.querySelectorAll('[data-type="motor-volume"] .btn-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-type="motor-volume"] .btn-option').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    calculateTaxAdvantage();
                });
            });
            
            // Satış süresi butonları
            document.querySelectorAll('[data-type="sale-period"] .btn-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-type="sale-period"] .btn-option').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    calculateTaxAdvantage();
                });
            });
            
            // Varsayılan olarak ilk butonları seçili yap
            document.querySelector('[data-type="motor-volume"] .btn-option').click();
            document.querySelector('[data-type="sale-period"] .btn-option:nth-child(4)').click();
        }
        
        // Gider tablosunu ayarlama
        function setupExpenseTable() {
            // Gider ekle butonu
            document.getElementById('addExpense').addEventListener('click', addExpenseRow);
            
            // Başlangıçta 3 gider satırı ekle
            addExpenseRow('fuel', '15000');
            addExpenseRow('insurance', '8000');
            addExpenseRow('maintenance', '5000');
        }
        
        // Yeni gider satırı ekleme
        function addExpenseRow(expenseType = 'fuel', amount = '') {
            const tbody = document.querySelector('#expensesTable tbody');
            const newRow = document.createElement('tr');
            
            // Gider türü seçenekleri
            let optionsHTML = '';
            for (const [key, value] of Object.entries(expenseDeductibility)) {
                const name = {
                    'mtv': 'MTV',
                    'fuel': 'Yakıt',
                    'insurance': 'Sigorta',
                    'maintenance': 'Bakım',
                    'tires': 'Lastik',
                    'parking': 'Otopark',
                    'cleaning': 'Temizlik',
                    'leasing': 'Leasing',
                    'other': 'Diğer'
                }[key];
                
                const selected = key === expenseType ? 'selected' : '';
                optionsHTML += `<option value="${key}" ${selected}>${name}</option>`;
            }
            
            newRow.innerHTML = `
                <td>
                    <select class="expense-type">
                        ${optionsHTML}
                    </select>
                </td>
                <td><input type="text" class="expense-amount" placeholder="10.000" data-type="currency" value="${amount}"></td>
                <td class="deductible-rate">${(expenseDeductibility[expenseType] * 100)}%</td>
                <td><button type="button" class="btn btn-secondary remove-expense">Sil</button></td>
            `;
            
            tbody.appendChild(newRow);
            
            // Format currency input
            const amountInput = newRow.querySelector('.expense-amount');
            formatCurrencyInput(amountInput);
            
            // Silme butonu event listener
            newRow.querySelector('.remove-expense').addEventListener('click', function() {
                if (document.querySelectorAll('#expensesTable tbody tr').length > 1) {
                    this.closest('tr').remove();
                    calculateTaxAdvantage();
                } else {
                    alert('En az bir gider kalemi olmalıdır.');
                }
            });
            
            // Gider türü değiştiğinde yazılabilirlik oranını güncelle
            newRow.querySelector('.expense-type').addEventListener('change', function() {
                const type = this.value;
                const rate = expenseDeductibility[type] * 100;
                this.closest('tr').querySelector('.deductible-rate').textContent = `${rate}%`;
                calculateTaxAdvantage();
            });
        }
        
        // Vergi avantajını hesaplama
        function calculateTaxAdvantage() {
            // Seçilen değerleri al
            const motorVolume = document.querySelector('[data-type="motor-volume"] .btn-option.active').dataset.value;
            const salePeriod = document.querySelector('[data-type="sale-period"] .btn-option.active').dataset.value;
            
            // Fiyat bilgilerini al
            const purchasePrice = parseNumber(document.getElementById('purchasePrice').value);
            const salePrice = parseNumber(document.getElementById('salePrice').value);
            
            // Vergi oranlarını hesapla
            const otvRate = getOtvRate(motorVolume);
            const kdvRate = 0.18; // %18 KDV
            
            // Alış vergileri
            const otvAmount = purchasePrice * otvRate;
            const kdvBase = purchasePrice + otvAmount;
            const kdvAmount = kdvBase * kdvRate;
            const totalCost = purchasePrice + otvAmount + kdvAmount;
            
            // Satış vergileri
            const saleKdv = salePrice * kdvRate;
            const kdvDifference = saleKdv - kdvAmount;
            
            // Giderleri hesapla
            let totalExpenses = 0;
            let totalDeductibleExpenses = 0;
            
            document.querySelectorAll('#expensesTable tbody tr').forEach(row => {
                const type = row.querySelector('.expense-type').value;
                const amount = parseNumber(row.querySelector('.expense-amount').value);
                const deductibleRate = expenseDeductibility[type];
                const deductibleAmount = amount * deductibleRate;
                
                totalExpenses += amount;
                totalDeductibleExpenses += deductibleAmount;
            });
            
            // Amortisman hesapla
            const expenseLimit = getExpenseLimit(motorVolume);
            const depreciationRate = getDepreciationRate(salePeriod);
            const depreciation = Math.min(purchasePrice * depreciationRate, expenseLimit);
            
            // Vergi avantajı
            const grossTaxAdvantage = kdvDifference + totalDeductibleExpenses + depreciation;
            const netTaxAdvantage = grossTaxAdvantage * 0.25; // %25 kurumlar vergisi
            
            // Sonuçları göster
            displayResults({
                motorVolume,
                salePeriod,
                purchasePrice,
                salePrice,
                otvRate,
                kdvRate,
                otvAmount,
                kdvAmount,
                totalCost,
                saleKdv,
                kdvDifference,
                totalExpenses,
                totalDeductibleExpenses,
                depreciationRate,
                depreciation,
                expenseLimit,
                grossTaxAdvantage,
                netTaxAdvantage
            });
            
            // Grafik güncelle
            updateChart(otvAmount, kdvAmount, depreciation, totalDeductibleExpenses);
            
            // AI önerileri oluştur
            generateAIRecommendations({
                motorVolume,
                salePeriod,
                purchasePrice,
                salePrice,
                netTaxAdvantage,
                depreciation,
                totalDeductibleExpenses,
                expenseLimit
            });
        }
        
        // Sonuçları gösterme
        function displayResults(data) {
            document.getElementById('otvRate').textContent = (data.otvRate * 100);
            document.getElementById('depreciationRate').textContent = (data.depreciationRate * 100);
            
            document.getElementById('resultPurchasePrice').textContent = formatCurrency(data.purchasePrice);
            document.getElementById('resultOtv').textContent = formatCurrency(data.otvAmount);
            document.getElementById('resultKdv').textContent = formatCurrency(data.kdvAmount);
            document.getElementById('resultTotalCost').textContent = formatCurrency(data.totalCost);
            
            document.getElementById('resultSalePrice').textContent = formatCurrency(data.salePrice);
            document.getElementById('resultSaleKdv').textContent = formatCurrency(data.saleKdv);
            document.getElementById('resultKdvDifference').textContent = formatCurrency(data.kdvDifference);
            
            document.getElementById('resultDepreciation').textContent = formatCurrency(data.depreciation);
            document.getElementById('resultExpenses').textContent = formatCurrency(data.totalDeductibleExpenses);
            document.getElementById('resultExpenseLimit').textContent = formatCurrency(data.expenseLimit);
            document.getElementById('resultTaxAdvantage').textContent = formatCurrency(data.netTaxAdvantage);
            document.getElementById('summaryTaxAdvantage').textContent = formatCurrency(data.netTaxAdvantage);
            
            // Sonuçları göster
            document.getElementById('results').classList.remove('hidden');
        }
        
        // Grafik güncelleme
        function updateChart(otv, kdv, depreciation, expenses) {
            const ctx = document.getElementById('taxChart').getContext('2d');
            
            if (taxChart) {
                taxChart.destroy();
            }
            
            taxChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ÖTV', 'KDV', 'Amortisman', 'Giderler'],
                    datasets: [{
                        label: 'Vergi Avantajı Kalemleri',
                        data: [otv, kdv, depreciation, expenses],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value).replace('₺', '') + ' TL';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Vergi Avantajı Dağılımı',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }
        
        // AI önerileri oluşturma
        function generateAIRecommendations(data) {
            const recommendationEl = document.getElementById('aiRecommendation');
            const textEl = document.getElementById('aiRecommendationText');
            
            if (data.purchasePrice === 0 || data.salePrice === 0) {
                recommendationEl.classList.add('hidden');
                return;
            }
            
            recommendationEl.classList.remove('hidden');
            
            const profit = data.salePrice - data.purchasePrice;
            const profitPercentage = (profit / data.purchasePrice) * 100;
            
            let recommendations = [];
            
            // Satış süresi önerileri
            if (data.salePeriod < 24 && profit > 0) {
                recommendations.push(`<strong>24 aylık satış süresini</strong> değerlendirebilirsiniz. Bu size <strong>%80 amortisman</strong> avantajı sağlayacaktır.`);
            } else if (data.salePeriod === 24 && profit < 0) {
                recommendations.push(`Zarar ettiğiniz bu işlemde <strong>daha kısa satış süresi</strong> (18 ay gibi) zararınızı azaltabilir.`);
            }
            
            // Motor hacmi önerileri
            if (data.motorVolume === 'above' && profitPercentage < 15) {
                recommendations.push(`Büyük motorlu araçlarda gider sınırı daha düşük (${formatCurrency(data.expenseLimit)}). Daha küçük motorlu araçlarda avantajlar daha yüksek olabilir.`);
            }
            
            // Genel öneriler
            if (profitPercentage > 25) {
                recommendations.push(`Yüksek kar marjı elde ediyorsunuz. Vergi avantajlarıyla birlikte bu işlem oldukça karlı görünüyor.`);
            } else if (profitPercentage < 0) {
                recommendations.push(`Satış fiyatı alış fiyatının altında. Vergi avantajları zararınızı <strong>${formatCurrency(data.netTaxAdvantage)}</strong> kadar telafi edecektir.`);
            } else {
                recommendations.push(`Makul bir kar marjı elde ediyorsunuz. Vergi avantajlarıyla birlikte işleminiz karlı görünüyor.`);
            }
            
            // Gider optimizasyonu
            if (data.totalDeductibleExpenses < data.expenseLimit * 0.5) {
                recommendations.push(`Giderleriniz gider sınırının altında. Daha fazla <strong>sigorta, bakım ve leasing gideri</strong> ekleyerek vergi avantajınızı artırabilirsiniz.`);
            }
            
            // Varsayılan öneri
            if (recommendations.length === 0) {
                recommendations.push(`Vergi avantajları işleminizi daha karlı hale getiriyor. Mevcut parametreler makul görünüyor.`);
            }
            
            // Net avantaj bilgisi
            recommendations.push(`<div style="margin-top:20px; padding:15px; background:white; border-radius:8px; border-left:4px solid ${profitPercentage > 0 ? '#27ae60' : '#e74c3c'}">
                <strong>Net Vergi Avantajınız:</strong> ${formatCurrency(data.netTaxAdvantage)}
            </div>`);
            
            textEl.innerHTML = recommendations.join('<br><br>');
        }
        
        // Senaryoyu otomatik optimize etme
        function optimizeScenario() {
            // Motor hacmi optimizasyonu
            const motorButtons = document.querySelectorAll('[data-type="motor-volume"] .btn-option');
            let bestMotor = '1600';
            let bestMotorAdvantage = 0;
            
            motorButtons.forEach(btn => {
                btn.click();
                calculateTaxAdvantage();
                const advantage = parseNumber(document.getElementById('resultTaxAdvantage').textContent);
                if (advantage > bestMotorAdvantage) {
                    bestMotorAdvantage = advantage;
                    bestMotor = btn.dataset.value;
                }
            });
            
            document.querySelector(`[data-type="motor-volume"] .btn-option[data-value="${bestMotor}"]`).click();
            
            // Satış süresi optimizasyonu
            const timeButtons = document.querySelectorAll('[data-type="sale-period"] .btn-option');
            let bestTime = '6';
            let bestTimeAdvantage = 0;
            
            timeButtons.forEach(btn => {
                btn.click();
                calculateTaxAdvantage();
                const advantage = parseNumber(document.getElementById('resultTaxAdvantage').textContent);
                if (advantage > bestTimeAdvantage) {
                    bestTimeAdvantage = advantage;
                    bestTime = btn.dataset.value;
                }
            });
            
            document.querySelector(`[data-type="sale-period"] .btn-option[data-value="${bestTime}"]`).click();
            
            // Gider optimizasyonu
            const expenseRows = document.querySelectorAll('#expensesTable tbody tr');
            expenseRows.forEach(row => {
                const typeSelect = row.querySelector('.expense-type');
                const types = Array.from(typeSelect.options).map(opt => opt.value);
                
                let bestType = types[0];
                let bestTypeAdvantage = 0;
                
                types.forEach(type => {
                    typeSelect.value = type;
                    calculateTaxAdvantage();
                    const advantage = parseNumber(document.getElementById('resultTaxAdvantage').textContent);
                    if (advantage > bestTypeAdvantage) {
                        bestTypeAdvantage = advantage;
                        bestType = type;
                    }
                });
                
                typeSelect.value = bestType;
                row.querySelector('.deductible-rate').textContent = `${expenseDeductibility[bestType] * 100}%`;
            });
            
            calculateTaxAdvantage();
            
            // Optimizasyon tamamlandı mesajı
            document.getElementById('aiRecommendationText').innerHTML = 
                `<div style="background:#d5f5e3; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <strong>✓ Optimizasyon Tamamlandı!</strong> En yüksek vergi avantajı sağlayan ayarlar uygulandı.
                </div>` + 
                document.getElementById('aiRecommendationText').innerHTML;
        }
        
        // PDF olarak kaydetme
        function exportToPDF() {
            const element = document.getElementById('results');
            
            html2canvas(element).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save('arac-vergi-avantaj-raporu.pdf');
            });
        }
    </script>
</body>
</html>